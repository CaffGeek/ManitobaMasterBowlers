<div class="sitemap-page">
  <div class="sitemap-layout">
    <div class="sitemap-tree">
      <div class="sitemap-tree-header">
        <span>Menu</span>
        <button class="btn btn-link sitemap-add-root" (click)="addPage()" title="Add page">
          +
        </button>
      </div>
      <ng-template #nodeList let-nodes let-parentId="parentId">
        <div
          class="sitemap-tree-list"
          *ngIf="nodes.length > 0"
        >
          <div
            class="sitemap-tree-item"
            *ngFor="let node of nodes; let index = index; let last = last"
            [class.is-selected]="node.page.id === selectedPageId"
          >
            <div
              class="sitemap-tree-row"
              (click)="selectPage(node.page.id)"
            >
              <span class="sitemap-tree-title">{{ node.page.title }}</span>
              <span class="sitemap-tree-meta">
                <button
                  class="btn btn-link sitemap-move"
                  (click)="moveNode(nodes, index, index - 1); $event.stopPropagation()"
                  [disabled]="index === 0"
                  title="Move up"
                >
                  ▲
                </button>
                <button
                  class="btn btn-link sitemap-move"
                  (click)="moveNode(nodes, index, index + 1); $event.stopPropagation()"
                  [disabled]="last"
                  title="Move down"
                >
                  ▼
                </button>
                <button
                  class="btn btn-link sitemap-add-inline"
                  (click)="addPage(node.page.id); $event.stopPropagation()"
                  title="Add child page"
                  *ngIf="!isSectionPage(node.page); else addPlaceholder"
                >
                  +
                </button>
                <ng-template #addPlaceholder>
                  <span class="sitemap-add-placeholder" aria-hidden="true"></span>
                </ng-template>
              </span>
            </div>
            <ng-container
              [ngTemplateOutlet]="nodeList"
              [ngTemplateOutletContext]="{ $implicit: node.children, parentId: node.page.id }"
            ></ng-container>
          </div>
        </div>
      </ng-template>
      <ng-container
        *ngIf="tree.length > 0"
        [ngTemplateOutlet]="nodeList"
        [ngTemplateOutletContext]="{ $implicit: tree, parentId: undefined }"
      ></ng-container>
      <div class="sitemap-empty" *ngIf="tree.length === 0">
        No pages yet. Click “Add Page” to get started.
      </div>
    </div>

    <div class="sitemap-detail">
      <div class="sitemap-editor" *ngIf="selectedPage as page; else sitemapEmptySelection">
        <div class="sitemap-editor-header">
          <h2>{{ page.title || 'Page details' }}</h2>
          <button class="btn btn-outline-danger" (click)="removePage(page.id)">Delete</button>
        </div>
        <div class="sitemap-form">
          <div class="sitemap-field">
            <label class="sitemap-label">Title</label>
            <input class="form-control" [(ngModel)]="page.title" (blur)="updateSlug(page)" />
          </div>

          <div class="sitemap-field">
            <label class="sitemap-label">Parent</label>
            <select
              class="form-control"
              [(ngModel)]="page.parentId"
              (ngModelChange)="onParentChange(page)"
            >
              <option *ngFor="let option of getParentOptions(page)" [ngValue]="option.id">
                {{ option.label }}
              </option>
            </select>
          </div>

        <div class="sitemap-field">
          <label class="sitemap-label">Type</label>
          <select class="form-control" [(ngModel)]="page.type" (ngModelChange)="onTypeChange(page)">
            <option *ngFor="let type of pageTypes" [ngValue]="type.value">{{ type.label }}</option>
          </select>
        </div>

        <ng-container *ngIf="page.type === 'content'">
          <div class="sitemap-field">
            <label class="sitemap-label">Content Block</label>
            <select class="form-control" [(ngModel)]="page.contentKey">
              <option [ngValue]="''">[New Content]</option>
              <option *ngFor="let key of contentKeys" [ngValue]="key">{{ key }}</option>
            </select>
          </div>
        </ng-container>

          <div class="sitemap-field" *ngIf="page.type === 'route'">
            <label class="sitemap-label">Route</label>
            <input class="form-control" [(ngModel)]="page.routePath" placeholder="/path" />
          </div>
          <div class="sitemap-field" *ngIf="page.type === 'external'">
            <label class="sitemap-label">URL</label>
            <input class="form-control" [(ngModel)]="page.externalUrl" placeholder="https://example.com" />
          </div>

          <div class="sitemap-footer">
            <button class="btn btn-primary" (click)="save()">Save</button>
          </div>
        </div>
      </div>
    <div class="sitemap-preview" *ngIf="selectedPage as page">
      <h3>Preview</h3>
      <div class="sitemap-preview__content" *ngIf="page.type === 'content'">
        <ng-container *ngIf="getSectionsFor(page).length === 0; else previewWithSidebar">
          <app-content-block [key]="page.contentKey || page.slug"></app-content-block>
        </ng-container>
        <ng-template #previewWithSidebar>
          <div class="sitemap-preview__layout">
            <aside class="sitemap-preview__sidebar">
              <ul class="sitemap-preview__menu">
                <li *ngFor="let section of getSectionsFor(page)">{{ section.title }}</li>
              </ul>
            </aside>
            <main class="sitemap-preview__main">
              <app-content-block [key]="page.contentKey || page.slug"></app-content-block>
            </main>
          </div>
        </ng-template>
      </div>
        <div class="sitemap-preview__placeholder" *ngIf="page.type !== 'content'">
          Preview is only available for content pages.
        </div>
      </div>
      <ng-template #sitemapEmptySelection>
        <div class="sitemap-editor">
          <h2>Select a page</h2>
          <p class="sitemap-subtitle">Choose a page from the left to edit its settings.</p>
        </div>
      </ng-template>
    </div>
  </div>
</div>
